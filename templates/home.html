{% extends "base.html" %}

{% block title %}Student Money Mate{% endblock %}

{% block content %}
        {% if not flat_groups %}
        <div class="buttons">
            <button id="createFlatBtn">Create Flat Group</button>
            <form action="{{ url_for('join_flat') }}" method="POST" style="display: inline;">
                <input type="text" name="flatGroupId" placeholder="Enter Flat Group ID" required>
                <button type="submit">Join Flat</button>
            </form>
        </div>
        {% else %}
        <div class="group-info">
            {% if group_message %}
                <p>{{ group_message }}</p>
            {% else %}
                <p><strong>Flat Group:</strong> {{ flat_group_names | join(', ') }}</p>
                <p><strong>Manager:</strong> {{ manager_name }}</p>
                <p><strong>Non-flat Groups:</strong> {{ non_flat_group_names | join(', ') }}</p>
            {% endif %}
        </div>
        <h2>Flat Bills</h2>
        <div class="bills">
            {% if flat_bills %}
            <table>
                <tr>
                    <th>Bills</th>
                    <th>Total Cost (monthly)</th>
                    <th>Personal Cost</th>
                    <th>Paid</th>
                    <th>Due Date</th>
                </tr>
                {% for bill in flat_bills %}
                <tr>
                    <td>{{ bill.bill_name }}</td>
                    <td>£{{ bill.amount }}</td>
                    <td>£{{ '%.2f' % bill.personal_cost }}</td>
                    <td>{{ bill.paid }}</td>
                    <td>{{ bill.due_date.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p>No flat bills available.</p>
            {% endif %}
        </div>
        <div class="owed-info">
            <p><strong>Owed:</strong> £{{ '%.2f' % total_flat_owed }} to {{ manager_name }}</p>
        </div>
        <h2>Non-flat Bills</h2>
        <div class="bills">
            {% if non_flat_bills %}
            <table>
                <tr>
                    <th>Bills</th>
                    <th>Group Members</th>
                    <th>Group Manager</th>
                    <th>Total Cost</th>
                    <th>Your Share</th>
                    <th>Paid</th>
                </tr>
                {% for bill in non_flat_bills %}
                <tr>
                    <td>{{ bill.bill_name }}</td>
                    <td>{{ bill.group_members }}</td>
                    <td>{{ bill.group_manager }}</td>
                    <td>£{{ bill.amount }}</td>
                    <td>£{{ '%.2f' % bill.personal_cost }}</td>
                    <td>{{ bill.paid }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p>No non-flat bills available.</p>
            {% endif %}
        </div>
        <div class="owed-info">
            <h3>Individual Amounts Owed</h3>
            <table>
                <tr>
                    <th>Manager</th>
                    <th>Amount Owed</th>
                </tr>
                {% for manager, amount in individual_owed.items() %}
                <tr>
                    <td>{{ manager }}</td>
                    <td>£{{ '%.2f' % amount }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        <div class="owed-info">
            <p><strong>Total Owed (Non-flat):</strong> £{{ '%.2f' % total_non_flat_owed }}</p>
        </div>
        <div class="buttons">
            <button id="addSplitBtn">Add a Split</button>
            <button>I have paid Someone</button>
        </div>
        {% endif %}
    </div>

<!-- Modal for Creating a Flat Group -->
<div id="createFlatModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <form id="createFlatForm" action="{{ url_for('create_flat') }}" method="POST">
            <label for="flatGroupName">Flat Group Name:</label>
            <input type="text" id="flatGroupName" name="flatGroupName" required>
            <br><br>
            <button type="submit">Create Flat Group</button>
        </form>
    </div>
</div>

<!-- Modal for Adding a Split -->
<div id="addSplitModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <form id="addSplitForm" action="{{ url_for('add_split') }}" method="POST">
            <label for="splitType">Select Type:</label>
            <select id="splitType" name="splitType" required>
                <option value="subgroup">Subgroup</option>
                <option value="event">Event</option>
            </select>
            <br><br>
            <label for="groupSelection">Select Group:</label>
            <div id="groupSelection">
                <input type="radio" name="groupOption" value="existing" id="existingGroup" checked> Existing Group
                <br>
                <table id="existingGroupsTable">
                    <tr>
                        <th>Select</th>
                        <th>Group Name</th>
                    </tr>
                    {% for group in flat_groups + non_flat_groups %}
                    <tr>
                        <td><input type="radio" name="selectedGroup" value="{{ group.group_id }}"></td>
                        <td>{{ group.group_name }}</td>
                    </tr>
                    {% endfor %}
                </table>
                <br>
                <input type="radio" name="groupOption" value="new" id="newGroup"> New Group
                <br>
                <div id="newGroupUsers" style="display:none;">
                    <label for="newGroupName">New Group Name:</label>
                    <input type="text" id="newGroupName" name="newGroupName">
                    <br><br>
                    <label>Select Users:</label>
                    {% for user in flat_group_members %}
                    <div>
                        <input type="checkbox" name="selectedUsers" value="{{ user.user_id }}"> {{ user.user_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <br><br>
            <label for="billName">Bill Name:</label>
            <input type="text" id="billName" name="billName" required>
            <br><br>
            <label for="billAmount">Bill Amount:</label>
            <input type="number" id="billAmount" name="billAmount" step="0.01" required>
            <br><br>
            <button type="submit">Add Split</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Get modal elements
        var addSplitModal = document.getElementById("addSplitModal");
        var addSplitBtn = document.getElementById("addSplitBtn");
        var addSplitSpan = addSplitModal.getElementsByClassName("close")[0];

        var createFlatModal = document.getElementById("createFlatModal");
        var createFlatBtn = document.getElementById("createFlatBtn");
        var createFlatSpan = createFlatModal.getElementsByClassName("close")[0];

        var existingGroupRadio = document.getElementById("existingGroup");
        var newGroupRadio = document.getElementById("newGroup");
        var newGroupUsersDiv = document.getElementById("newGroupUsers");

        // Ensure elements are selected correctly
        console.log(createFlatBtn, createFlatModal, createFlatSpan, addSplitBtn);

        // When the user clicks the button, open the modal
        if (addSplitBtn) {
            addSplitBtn.onclick = function() {
                console.log("Add Split Button Clicked");
                addSplitModal.style.display = "block";
            }
        }

        if (createFlatBtn) {
            createFlatBtn.onclick = function() {
                console.log("Create Flat Button Clicked");
                createFlatModal.style.display = "block";
            }
        }

        // When the user clicks on <span> (x), close the modal
        if (addSplitSpan) {
            addSplitSpan.onclick = function() {
                addSplitModal.style.display = "none";
            }
        }

        if (createFlatSpan) {
            createFlatSpan.onclick = function() {
                createFlatModal.style.display = "none";
            }
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == addSplitModal) {
                addSplitModal.style.display = "none";
            } else if (event.target == createFlatModal) {
                createFlatModal.style.display = "none";
            }
        }

        // Show/Hide new group users selection based on radio button
        if (existingGroupRadio) {
            existingGroupRadio.onclick = function() {
                newGroupUsersDiv.style.display = "none";
            }
        }

        if (newGroupRadio) {
            newGroupRadio.onclick = function() {
                newGroupUsersDiv.style.display = "block";
            }
        }
    });
</script>

</body>
</html>
{% endblock %}